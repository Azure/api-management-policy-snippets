<policies>
    <inbound>
        <!-- Grab the incoming session cookie (encrypted)-->
        <set-variable name="encryptedIncomingFullSessionCookie" value="@(context.Request.Headers.ContainsKey("cookie") ? context.Request.Headers.GetValueOrDefault("cookie", "").Split(';').Select(x => x.Trim()).Select(cookie => cookie.Split('=')).SingleOrDefault(cookie => cookie[0] == "{{CookiePrefix}}")?[1] ?? string.Empty : string.Empty)" />

        <choose>
            <!-- No cookie - redirect to the sign-in endpoint -->
            <when condition="@(context.Variables["encryptedIncomingFullSessionCookie"] == string.Empty)">
                <return-response>
                    <set-status code="302" />
                    <set-header name="Location" exists-action="override">
                        <value>@($"/oauth/signin?redirect={Uri.EscapeDataString(context.Request.OriginalUrl.ToString())}")</value>
                    </set-header>
                </return-response>
            </when>
            <!-- Cookie not the right format - redirect to the sign-in endpoint -->
            <when condition="@(((string)context.Variables["encryptedIncomingFullSessionCookie"]).Split('.').Length != 3)">
                <return-response>
                    <set-status code="401" reason="Incorrect formed cookie" />
                </return-response>
            </when>
        </choose>

        <!-- get the IV from cache, and decrypt the contents of the cookie -->
        <set-variable name="encryptedCookie" value="@(((string)context.Variables["encryptedIncomingFullSessionCookie"]).Split('.')[0])" />
        <set-variable name="ivCookie" value="@(((string)context.Variables["encryptedIncomingFullSessionCookie"]).Split('.')[1])" />
        <set-variable name="cookieKey" value="@(((string)context.Variables["encryptedIncomingFullSessionCookie"]).Split('.')[2])" />
        <choose>
            <!-- Cookie not the right format - redirect to the sign-in endpoint -->
            <when condition="@(((string)context.Variables["ivCookie"]) == string.Empty)">
                <return-response>
                    <set-status code="302" />
                    <set-header name="Location" exists-action="override">
                        <value>@($"/oauth/signin?redirect={(string)context.Variables["redirect-no-cookie"]}")</value>
                    </set-header>
                </return-response>
            </when>
        </choose>

        <!-- next step is to decrypt the cookie. This will yield an IV that can decrypt the tokens, and a timestamp-->
        <set-variable name="incomingFullSessionCookie" value="@{
            try {
                var cookieBytes = Convert.FromBase64String(((string)context.Variables["encryptedCookie"]));
                var iv = Guid.Parse((string)context.Variables["ivCookie"]).ToByteArray();
                var key1 = Convert.FromBase64String("{{CookieEncryptionKey1}}");
                var key2 = Convert.FromBase64String("{{CookieEncryptionKey2}}");
                var key = (string)context.Variables["cookieKey"]  == "1" ? key1 : key2;
                var decryptedBytes = cookieBytes.Decrypt("Aes", key, iv);
                return Encoding.UTF8.GetString(decryptedBytes);
            } catch (Exception e) {
                return "";
            }
        }" />
        <choose>
            <!-- Failed to decrypt the incoming cookie -->
            <when condition="@(((string)context.Variables["incomingFullSessionCookie"]) == string.Empty)">
                <return-response>
                    <set-status code="302" />
                    <set-header name="Location" exists-action="override">
                        <value>@($"/oauth/signin?redirect={(string)context.Variables["redirect-no-cookie"]}")</value>
                    </set-header>
                </return-response>
            </when>
        </choose>

        <!-- clear out the cookies / state / etc and redirect them back to where they came from-->
        <set-variable name="cacheKey" value="@(((string)context.Variables["incomingFullSessionCookie"]).Split('.')[0])" />
        <cache-remove-value key="@($"tokens-{context.Variables["cacheKey"]}-accessToken")" />
        <cache-remove-value key="@($"tokens-{context.Variables["cacheKey"]}-idToken")" />
        <cache-remove-value key="@($"tokens-{context.Variables["cacheKey"]}-refreshToken")" />
        <cache-remove-value key="@($"tokens-{context.Variables["cacheKey"]}-refreshAt")" />
        <!-- Grab the incoming session cookie -->
        <set-variable name="redirect" value="@(Uri.UnescapeDataString(context.Request.Url.Query.GetValueOrDefault("redirect", string.Empty)))" />
        <choose>
            <!-- Without a redirect we don't know where to send them back to. Error out the flow -->
            <when condition="@(context.Variables["redirect"] == string.Empty)">
                <return-response>
                    <set-status code="200" reason="OK" />
                    <set-header name="Set-Cookie" exists-action="override">
                        <value>@($"{{CookiePrefix}}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT")</value>
                    </set-header>
                    <set-body />
                </return-response>
            </when>
            <!-- Check if the redirect is to one of the oauth endpoints. This would create a redirect loop. Let's not allow this -->
            <when condition="@(new Uri((string)context.Variables["redirect"]).AbsolutePath.StartsWith("/oauth", StringComparison.InvariantCultureIgnoreCase))">
                <return-response>
                    <set-status code="200" reason="OK" />
                    <set-header name="Set-Cookie" exists-action="override">
                        <value>@($"{{CookiePrefix}}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT")</value>
                    </set-header>
                    <set-body />
                </return-response>
            </when>
            <otherwise>
                <return-response>
                    <set-status code="302" reason="OK" />
                    <set-header name="Location" exists-action="override">
                        <value>@((string)context.Variables["redirect"])</value>
                    </set-header>
                    <set-header name="Set-Cookie" exists-action="override">
                        <value>@($"{{CookiePrefix}}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT")</value>
                    </set-header>
                </return-response>
            </otherwise>
        </choose>
        <base />
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>